<%- include('admin-partials/header.ejs') %>

<div class="screen-overlay"></div>

<aside class="navbar-aside" id="offcanvas_aside">
    <div class="aside-top">
        <a href="index.html" class="brand-wrap">
            <img
                src="/assets/imgs/theme/techoasis_logo.png"
                class="logo"
                alt="inloop Dashboard"
            />
        </a>
        <div>
            <button class="btn btn-icon btn-aside-minimize">
                <i class="text-muted material-icons md-menu_open"></i>
            </button>
        </div>
    </div>
    <nav>
        <ul class="menu-aside">
            <li class="menu-item">
                <a class="menu-link" href="/admin">
                    <i class="icon material-icons md-home"></i>
                    <span class="text">Dashboard</span>
                </a>
            </li>
            <li class="menu-item active">
                <a class="menu-link" href="/admin/usermanagement">
                    <i class="icon material-icons md-person"></i>
                    <span class="text">User Management</span>
                </a>
            </li>
            <li class="menu-item">
                <a class="menu-link" href="/admin/product-management">
                    <i class="icon material-icons md-shopping_bag"></i>
                    <span class="text">Product Management</span>
                </a>
            </li>

            <li class="menu-item">
                <a class="menu-link" href="/admin/category-management">
                    <i class="icon material-icons md-category"></i>
                    <span class="text">Category Management</span>
                </a>
            </li>
            <li class="menu-item">
                <a class="menu-link" href="/admin/order-management">
                    <i class="icon material-icons md-shopping_cart"></i>
                    <span class="text">Order Management</span>
                </a>
            </li>

            <li class="menu-item">
                <a class="menu-link" href="/admin/coupon-management">
                    <i class="icon material-icons md-redeem coupon-icon"></i>
                    <span class="text">Coupon Management</span>
                </a>
            </li>
        </ul>

        <br />
        <br />
    </nav>
</aside>

<main class="main-wrap">
    <header class="main-header navbar">
        <div class="col-nav ms-auto">
            <button
                class="btn btn-icon btn-mobile me-auto"
                data-trigger="#offcanvas_aside"
            >
                <i class="material-icons md-apps"></i>
            </button>
            <ul class="nav">
                <li class="nav-item">
                    <a class="nav-link btn-icon darkmode" href="#">
                        <i class="material-icons md-nights_stay"></i>
                    </a>
                </li>
                <li class="dropdown nav-item">
                    <a class="dropdown-item text-danger" href="/admin/logout"
                        ><i class="material-icons md-exit_to_app"></i>Logout</a
                    >
                </li>
            </ul>
        </div>
    </header>
    <section class="content-main">
        <div class="content-header">
            <div>
                <h2 class="content-title card-title">User Management</h2>
            </div>
            <!-- <div>
                <a href="#" class="btn btn-light rounded font-md">Export</a>
                <a href="#" class="btn btn-light rounded  font-md">Import</a>
                <a href="#" class="btn btn-primary btn-sm rounded">Create new</a>
            </div> -->
        </div>
        <div class="card mb-4">
            <!-- <header class="card-header">
                <div class="row align-items-center">
                    <div class="col col-check flex-grow-0">
                        <div class="form-check ms-2">
                            <input
                                class="form-check-input"
                                type="checkbox"
                                value=""
                            />
                        </div>
                    </div>
                    <div class="col-md-3 col-12 me-auto mb-md-0 mb-3">
                        <select class="form-select">
                            <option selected>All category</option>
                            <option>Electronics</option>
                            <option>Clothes</option>
                            <option>Automobile</option>
                        </select>
                    </div>
                    <div class="col-md-2 col-6">
                        <input
                            type="date"
                            value="02.05.2022"
                            class="form-control"
                        />
                    </div>
                    <div class="col-md-2 col-6">
                        <select class="form-select">
                            <option selected>Status</option>
                            <option>Active</option>
                            <option>Disabled</option>
                            <option>Show all</option>
                        </select>
                    </div>
                </div>
            </header> -->
            <!-- card-header end// -->

            <div class="container rounded py-3">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="border rounded">
                            <tr class="text-center">
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Mobile Number</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody class="border rounded">
                            <% userdetails?.forEach((item, index) => { %>
                            <tr class="text-center">
                                <td>
                                    <%= (currentPage - 1) * perPage + index + 1
                                    %>
                                </td>
                                <td><%= item.fullname %></td>
                                <td><%= item.email %></td>
                                <td><%= item.phone %></td>
                                <td>
                                    <button onclick="confirmBlock('<%= item._id %>')"
                                        id="blockButton_<%= item._id %>"
                                        class="btn <%= item.isBlocked ? 'btn-success' : 'btn-danger' %>"
                                        style="width: 100px">
                                        <%= item.isBlocked ? 'Unblock' : 'Block'
                                        %>
                                    </button>
                                </td>
                            </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- pagination -->
            <div class="pagination-area mt-15 mb-sm-5 mb-lg-0">
                <nav aria-label="Page navigation example">
                    <ul class="pagination justify-content-start">
                        <% if (currentPage > 1) { %>
                            <li class="page-item">
                                <a class="page-link" href="?page=<%= currentPage - 1 %>">
                                    <i class="material-icons md-chevron_left"></i>
                                </a>
                            </li>
                        <% } %>
                        <% for (let i = Math.max(1, currentPage - 2); i <= Math.min(currentPage + 2, totalPages); i++) { %>
                            <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                                <a class="page-link" href="?page=<%= i %>">
                                    <%= i %>
                                </a>
                            </li>
                        <% } %>
                        <% if (currentPage < totalPages) { %>
                            <li class="page-item">
                                <a class="page-link" href="?page=<%= currentPage + 1 %>">
                                    <i class="material-icons md-chevron_right"></i>
                                </a>
                            </li>
                        <% } %>
                    </ul>
                </nav>
            </div>
        </div>
    </section>
    <!-- content-main end// -->

    <footer class="main-footer font-xs">
        <div class="row pb-30 pt-15">
            <div class="col-sm-6">
                <script>
                    document.write(new Date().getFullYear());
                </script>
                Â© <a href="/">Techoasis</a>
            </div>
            <div class="col-sm-6">
                <div class="text-sm-end">All rights reserved</div>
            </div>
        </div>
    </footer>
</main>

<!-- Include JavaScript -->
<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>  -->

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="/assets/js/vendors/jquery-3.6.0.min.js"></script>
<script src="/assets/js/vendors/jquery.fullscreen.min.js"></script>
<script src="/assets/js/vendors/bootstrap.bundle.min.js"></script>
<script src="/assets/js/vendors/select2.min.js"></script>
<script src="/assets/js/vendors/perfect-scrollbar.js"></script>

<!-- <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ajaxy/1.6.1/scripts/jquery.ajaxy.min.js"></script> -->

<!-- Main Script -->
<script src="/assets/js/main.js" type="text/javascript"></script>
<script>
    async function blockUser(id) {
        let response = await fetch("/admin/blockUser", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                id,
            }),
        });
        if (response.status === 200) {
            Swal.fire({
                    icon: 'success',
                    title: 'User Unblocked',
                    text: 'The user has been successfully unblocked.',
                    timer: 2500,
                    showConfirmButton: false,
                });
            document.getElementById("blockButton_" + id).className =
                "btn btn-danger";
            document.getElementById("blockButton_" + id).innerHTML = "Block";
        } else if (response.status === 201) {
            Swal.fire({
                icon: 'success',
                title: 'User Blocked',
                text: 'The user has been successfully blocked.',
                timer: 2500,
                showConfirmButton: false,
            });
            document.getElementById("blockButton_" + id).className =
                "btn btn-success";
            document.getElementById("blockButton_" + id).innerHTML = "Unblock";
        } else if (response.status === 402) {
            Swal.fire({
                icon: 'error',
                title: 'Session Expired',
                text: 'Your session has expired. Please log in again.',
                timer: 2500,
                showConfirmButton: false,
            }).then(() => {
                window.location.reload();
            });
        }
    }

    function confirmBlock(id) {
        var confirmationMessage =
            document.getElementById("blockButton_" + id).innerHTML.trim() ===
            "Block"
                ? "Are you sure you want to block this user?"
                : "Are you sure you want to unblock this user?";
                Swal.fire({
                title: confirmationMessage,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes',
                cancelButtonText: 'No',
            }).then((result) => {
                if (result.isConfirmed) {
                    blockUser(id);
                }
            });
    }
</script>

</body>
 
 </html>